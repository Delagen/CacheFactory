!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("cachefactory",t):e.CacheFactory=t()}(this,function(){"use strict";function e(e,t){if(e||(e=function(e){return e}),t||(t=function(e,t){return e===t}),"function"!=typeof e)throw new Error('BinaryHeap([weightFunc][, compareFunc]): "weightFunc" must be a function!');if("function"!=typeof t)throw new Error('BinaryHeap([weightFunc][, compareFunc]): "compareFunc" must be a function!');this.weightFunc=e,this.compareFunc=t,this.heap=[]}function t(e){var t=[],r=void 0;if(!f.isObject(e))return t;for(r in e)e.hasOwnProperty(r)&&t.push(r);return t}function r(e){return e&&"function"==typeof e.then}function i(e){return f.isNumber(e)?e.toString():e}function s(e){var t={},r=void 0;if(!f.isObject(e))return t;for(r in e)e.hasOwnProperty(r)&&(t[r]=r);return t}function n(n,o){if(n in m)throw new Error(n+" already exists!");if(!f.isString(n))throw new Error("cacheId must be a string!");var c={},l={},h=null,u=new e(function(e){return e.expires},f.equals),$=new e(function(e){return e.accessed},f.equals),v=m[n]={$$id:n,destroy:function(){clearInterval(this.$$cacheFlushIntervalId),clearInterval(this.$$recycleFreqId),this.removeAll(),h&&(h().removeItem(this.$$prefix+".keys"),h().removeItem(this.$$prefix)),h=null,c=null,$=null,u=null,this.$$prefix=null,delete m[this.$$id]},disable:function(){this.$$disabled=!0},enable:function(){delete this.$$disabled},get:function(e,t){var r=this;if(Array.isArray(e)){var s=function(){var i=e,s=[];return i.forEach(function(e){var i=r.get(e,t);null!==i&&void 0!==i&&s.push(i)}),{v:s}}();if("object"===("undefined"==typeof s?"undefined":a.typeof(s)))return s.v}else if(e=i(e),this.$$disabled)return;if(t=t||{},!f.isString(e))throw new Error("key must be a string!");if(t&&!f.isObject(t))throw new Error("options must be an object!");if(t.onExpire&&!f.isFunction(t.onExpire))throw new Error("options.onExpire must be a function!");var n=void 0;if(h){if(l[e])return l[e];var o=h().getItem(this.$$prefix+".data."+e);if(!o)return;n=f.fromJson(o)}else if(f.isObject(c)){if(!(e in c))return;n=c[e]}var u=n.value,p=(new Date).getTime();return h?($.remove({key:e,accessed:n.accessed}),n.accessed=p,$.push({key:e,accessed:p})):($.remove(n),n.accessed=p,$.push(n)),"passive"===this.$$deleteOnExpire&&"expires"in n&&n.expires<p?(this.remove(e),this.$$onExpire?this.$$onExpire(e,n.value,t.onExpire):t.onExpire&&t.onExpire.call(this,e,n.value),u=void 0):h&&h().setItem(this.$$prefix+".data."+e,JSON.stringify(n)),u},info:function(e){if(e){var t=void 0;if(h){var r=h().getItem(this.$$prefix+".data."+e);return r?(t=f.fromJson(r),{created:t.created,accessed:t.accessed,expires:t.expires,isExpired:(new Date).getTime()-t.created>(t.maxAge||this.$$maxAge)}):void 0}return f.isObject(c)&&e in c?(t=c[e],{created:t.created,accessed:t.accessed,expires:t.expires,isExpired:(new Date).getTime()-t.created>(t.maxAge||this.$$maxAge)}):void 0}return{id:this.$$id,capacity:this.$$capacity,maxAge:this.$$maxAge,deleteOnExpire:this.$$deleteOnExpire,onExpire:this.$$onExpire,cacheFlushInterval:this.$$cacheFlushInterval,recycleFreq:this.$$recycleFreq,storageMode:this.$$storageMode,storageImpl:h?h():void 0,disabled:!!this.$$disabled,size:$&&$.size()||0}},keys:function(){if(h){var e=h().getItem(this.$$prefix+".keys");return e?f.fromJson(e):[]}return t(c)},keySet:function(){if(h){var e=h().getItem(this.$$prefix+".keys"),t={};if(e)for(var r=f.fromJson(e),i=0;i<r.length;i++)t[r[i]]=r[i];return t}return s(c)},put:function(e,t,s){var n=this;s||(s={});var o="storeOnResolve"in s?!!s.storeOnResolve:this.$$storeOnResolve,a="storeOnReject"in s?!!s.storeOnReject:this.$$storeOnReject,p=function(t,r){return function(i){if(t&&(delete l[e],f.isObject(i)&&"status"in i&&"data"in i?(i=[i.status,i.data,i.headers(),i.statusText],n.put(e,i)):n.put(e,i)),r){if(f.Promise)return f.Promise.reject(i);throw i}return i}};if(!this.$$disabled&&f.isObject(c)&&null!==t&&void 0!==t){if(e=i(e),!f.isString(e))throw new Error("key must be a string!");var m=(new Date).getTime(),v={key:e,value:r(t)?t.then(p(o,!1),p(a,!0)):t,created:void 0===s.created?m:s.created,accessed:void 0===s.accessed?m:s.accessed};if(s.maxAge&&(v.maxAge=s.maxAge),void 0===s.expires?v.expires=v.created+(v.maxAge||this.$$maxAge):v.expires=s.expires,h){if(r(v.value))return l[e]=v.value,l[e];var d=h().getItem(this.$$prefix+".keys"),g=d?f.fromJson(d):[],y=h().getItem(this.$$prefix+".data."+e);y&&this.remove(e),u.push({key:e,expires:v.expires}),$.push({key:e,accessed:v.accessed}),h().setItem(this.$$prefix+".data."+e,JSON.stringify(v));for(var x=!1,b=0;b<g.length;b++)if(g[b]===e){x=!0;break}x||g.push(e),h().setItem(this.$$prefix+".keys",JSON.stringify(g))}else c[e]&&this.remove(e),u.push(v),$.push(v),c[e]=v,delete l[e];return $.size()>this.$$capacity&&this.remove($.peek().key),t}},remove:function(e){if(e+="",delete l[e],h){var t=h().getItem(this.$$prefix+".data."+e);if(t){var r=f.fromJson(t);$.remove({key:e,accessed:r.accessed}),u.remove({key:e,expires:r.expires}),h().removeItem(this.$$prefix+".data."+e);var i=h().getItem(this.$$prefix+".keys"),s=i?f.fromJson(i):[],n=s.indexOf(e);return n>=0&&s.splice(n,1),h().setItem(this.$$prefix+".keys",JSON.stringify(s)),r.value}}else if(f.isObject(c)){var o=c[e]?c[e].value:void 0;return $.remove(c[e]),u.remove(c[e]),c[e]=null,delete c[e],o}},removeAll:function(){if(h){$.removeAll(),u.removeAll();var e=h().getItem(this.$$prefix+".keys");if(e)for(var t=f.fromJson(e),r=0;r<t.length;r++)this.remove(t[r]);h().setItem(this.$$prefix+".keys",JSON.stringify([]))}else if(f.isObject(c)){$.removeAll(),u.removeAll();for(var i in c)c[i]=null;c={}}else $.removeAll(),u.removeAll(),c={};l={}},removeExpired:function(){for(var e=(new Date).getTime(),t={},r=void 0,i=void 0;(i=u.peek())&&i.expires<=e;)t[i.key]=i.value?i.value:null,u.pop();if(h)for(r in t){var s=h().getItem(this.$$prefix+".data."+r);s&&(t[r]=f.fromJson(s).value,this.remove(r))}else for(r in t)this.remove(r);if(this.$$onExpire)for(r in t)this.$$onExpire(r,t[r]);return t},setCacheFlushInterval:function(e){var t=this;if(null===e)delete t.$$cacheFlushInterval;else{if(!f.isNumber(e))throw new Error("cacheFlushInterval must be a number!");if(0>e)throw new Error("cacheFlushInterval must be greater than zero!");e!==t.$$cacheFlushInterval&&(t.$$cacheFlushInterval=e,clearInterval(t.$$cacheFlushIntervalId),t.$$cacheFlushIntervalId=setInterval(function(){t.removeAll()},t.$$cacheFlushInterval))}},setCapacity:function(e){if(null===e)delete this.$$capacity;else{if(!f.isNumber(e))throw new Error("capacity must be a number!");if(0>e)throw new Error("capacity must be greater than zero!");this.$$capacity=e}for(var t={};$.size()>this.$$capacity;)t[$.peek().key]=this.remove($.peek().key);return t},setDeleteOnExpire:function(e,t){if(null===e)delete this.$$deleteOnExpire;else{if(!f.isString(e))throw new Error("deleteOnExpire must be a string!");if("none"!==e&&"passive"!==e&&"aggressive"!==e)throw new Error('deleteOnExpire must be "none", "passive" or "aggressive"!');this.$$deleteOnExpire=e}t!==!1&&this.setRecycleFreq(this.$$recycleFreq)},setMaxAge:function(e){if(null===e)this.$$maxAge=Number.MAX_VALUE;else{if(!f.isNumber(e))throw new Error("maxAge must be a number!");if(0>e)throw new Error("maxAge must be greater than zero!");this.$$maxAge=e}var r=void 0,i=void 0,s=void 0;if(u.removeAll(),h){var n=h().getItem(this.$$prefix+".keys");for(i=n?f.fromJson(n):[],r=0;r<i.length;r++){s=i[r];var o=h().getItem(this.$$prefix+".data."+s);if(o){var a=f.fromJson(o);this.$$maxAge===Number.MAX_VALUE?a.expires=Number.MAX_VALUE:a.expires=a.created+(a.maxAge||this.$$maxAge),u.push({key:s,expires:a.expires})}}}else for(i=t(c),r=0;r<i.length;r++)s=i[r],this.$$maxAge===Number.MAX_VALUE?c[s].expires=Number.MAX_VALUE:c[s].expires=c[s].created+(c[s].maxAge||this.$$maxAge),u.push(c[s]);return"aggressive"===this.$$deleteOnExpire?this.removeExpired():{}},setOnExpire:function(e){if(null===e)delete this.$$onExpire;else{if(!f.isFunction(e))throw new Error("onExpire must be a function!");this.$$onExpire=e}},setOptions:function(e,t){if(e=e||{},t=!!t,!f.isObject(e))throw new Error("cacheOptions must be an object!");"storagePrefix"in e?this.$$storagePrefix=e.storagePrefix:t&&(this.$$storagePrefix=p.storagePrefix),this.$$prefix=this.$$storagePrefix+this.$$id,"disabled"in e?this.$$disabled=!!e.disabled:t&&(this.$$disabled=p.disabled),"deleteOnExpire"in e?this.setDeleteOnExpire(e.deleteOnExpire,!1):t&&this.setDeleteOnExpire(p.deleteOnExpire,!1),"recycleFreq"in e?this.setRecycleFreq(e.recycleFreq):t&&this.setRecycleFreq(p.recycleFreq),"maxAge"in e?this.setMaxAge(e.maxAge):t&&this.setMaxAge(p.maxAge),"storeOnResolve"in e?this.$$storeOnResolve=!!e.storeOnResolve:t&&(this.$$storeOnResolve=p.storeOnResolve),"storeOnReject"in e?this.$$storeOnReject=!!e.storeOnReject:t&&(this.$$storeOnReject=p.storeOnReject),"capacity"in e?this.setCapacity(e.capacity):t&&this.setCapacity(p.capacity),"cacheFlushInterval"in e?this.setCacheFlushInterval(e.cacheFlushInterval):t&&this.setCacheFlushInterval(p.cacheFlushInterval),"onExpire"in e?this.setOnExpire(e.onExpire):t&&this.setOnExpire(p.onExpire),"storageMode"in e||"storageImpl"in e?this.setStorageMode(e.storageMode||p.storageMode,e.storageImpl||p.storageImpl):t&&this.setStorageMode(p.storageMode,p.storageImpl)},setRecycleFreq:function(e){if(null===e)delete this.$$recycleFreq;else{if(!f.isNumber(e))throw new Error("recycleFreq must be a number!");if(0>e)throw new Error("recycleFreq must be greater than zero!");this.$$recycleFreq=e}clearInterval(this.$$recycleFreqId),"aggressive"===this.$$deleteOnExpire?!function(e){e.$$recycleFreqId=setInterval(function(){e.removeExpired()},e.$$recycleFreq)}(this):delete this.$$recycleFreqId},setStorageMode:function(e,t){function r(e,t){var r=this.keys(),i=r.length;if(i){for(var s=void 0,a=f.isObject(t),c=0;i>c;c++){if(s=r[c],e){var l=e().getItem(this.$$prefix+".data."+s);l&&(o[s]=f.fromJson(l))}else a&&(o[s]=t[s]);this.remove(s)}n=!0}}if(!f.isString(e))throw new Error("storageMode must be a string!");if("memory"!==e&&"localStorage"!==e&&"sessionStorage"!==e)throw new Error('storageMode must be "memory", "localStorage" or "sessionStorage"!');var i=h,s=c,n=!1,o={};if(this.$$initializing||r.call(this,i,s),this.$$storageMode=e,t){if(!f.isObject(t))throw new Error("storageImpl must be an object!");if(!("setItem"in t&&"function"==typeof t.setItem))throw new Error('storageImpl must implement "setItem(key, value)"!');if(!("getItem"in t&&"function"==typeof t.getItem))throw new Error('storageImpl must implement "getItem(key)"!');if(!("removeItem"in t)||"function"!=typeof t.removeItem)throw new Error('storageImpl must implement "removeItem(key)"!');h=function(){return t}}else if("localStorage"===this.$$storageMode)try{localStorage.setItem("cachefactory","cachefactory"),localStorage.removeItem("cachefactory"),h=function(){return localStorage}}catch(e){h=null,this.$$storageMode="memory"}else if("sessionStorage"===this.$$storageMode)try{sessionStorage.setItem("cachefactory","cachefactory"),sessionStorage.removeItem("cachefactory"),h=function(){return sessionStorage}}catch(e){h=null,this.$$storageMode="memory"}else h=null,this.$$storageMode="memory";if(this.$$initializing&&r.call(this,h,c),n){var a=void 0;for(var l in o)a=o[l],this.put(l,a.value,{created:a.created,accessed:a.accessed,expires:a.expires})}},touch:function(e,t){var r=this;if(e){var i=this.get(e,{onExpire:function(e,t){return r.put(e,t)}});i&&this.put(e,i,t)}else for(var s=this.keys(),n=0;n<s.length;n++)this.touch(s[n],t)},values:function(){for(var e=this.keys(),t=[],r=0;r<e.length;r++)t.push(this.get(e[r]));return t}};return v.$$initializing=!0,v.setOptions(o,!0),v.$$initializing=!1,v}function o(e,t){return n(e,t)}var a={};a.typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};var c=function(e,t,r){for(var i=e[r],s=t(i);r>0;){var n=Math.floor((r+1)/2)-1,o=e[n];if(s>=t(o))break;e[n]=i,e[r]=o,r=n}},l=function(e,t,r){for(var i=e.length,s=e[r],n=t(s);;){var o=2*(r+1),a=o-1,c=null;if(i>a){var l=e[a],h=t(l);n>h&&(c=a)}if(i>o){var u=e[o],f=t(u);f<(null===c?n:t(e[a]))&&(c=o)}if(null===c)break;e[r]=e[c],e[c]=s,r=c}},h=e.prototype;h.push=function(e){this.heap.push(e),c(this.heap,this.weightFunc,this.heap.length-1)},h.peek=function(){return this.heap[0]},h.pop=function(){var e=this.heap[0],t=this.heap.pop();return this.heap.length>0&&(this.heap[0]=t,l(this.heap,this.weightFunc,0)),e},h.remove=function(e){for(var t=this.heap.length,r=0;t>r;r++)if(this.compareFunc(this.heap[r],e)){var i=this.heap[r],s=this.heap.pop();return r!==t-1&&(this.heap[r]=s,c(this.heap,this.weightFunc,r),l(this.heap,this.weightFunc,r)),i}return null},h.removeAll=function(){this.heap=[]},h.size=function(){return this.heap.length};var u=null;try{u=window.Promise}catch(e){}var f={isNumber:function(e){return"number"==typeof e},isString:function(e){return"string"==typeof e},isObject:function(e){return null!==e&&"object"===("undefined"==typeof e?"undefined":a.typeof(e))},isFunction:function(e){return"function"==typeof e},fromJson:function(e){return JSON.parse(e)},equals:function(e,t){return e===t},Promise:u},p={capacity:Number.MAX_VALUE,maxAge:Number.MAX_VALUE,deleteOnExpire:"none",onExpire:null,cacheFlushInterval:null,recycleFreq:1e3,storageMode:"memory",storageImpl:null,disabled:!1,storagePrefix:"cachefactory.caches.",storeOnResolve:!1,storeOnReject:!1},m={};return o.createCache=n,o.defaults=p,o.info=function(){var e=t(m),r={size:e.length,caches:{}};for(var i in p)p.hasOwnProperty(i)&&(r[i]=p[i]);for(var s=0;s<e.length;s++){var n=e[s];r.caches[n]=m[n].info()}return r},o.get=function(e){return m[e]},o.keySet=function(){return s(m)},o.keys=function(){return t(m)},o.destroy=function(e){m[e]&&(m[e].destroy(),delete m[e])},o.destroyAll=function(){for(var e in m)m[e].destroy();m={}},o.clearAll=function(){for(var e in m)m[e].removeAll()},o.removeExpiredFromAll=function(){var e={};for(var t in m)e[t]=m[t].removeExpired();return e},o.enableAll=function(){for(var e in m)m[e].$$disabled=!1},o.disableAll=function(){for(var e in m)m[e].$$disabled=!0},o.touchAll=function(){for(var e in m)m[e].touch()},o.utils=f,o.BinaryHeap=e,o});
//# sourceMappingURL=cachefactory.min.map